{% extends "base.html" %}

{% block title %}Portfolio Analytics Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.5rem;
    color: white;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    z-index: 0;
}

.metric-card > * {
    position: relative;
    z-index: 1;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.positive { color: #10b981; }
.negative { color: #ef4444; }

.chart-container {
    position: relative;
    height: 300px;
    margin: 1rem 0;
}

.strategy-card {
    background: #1f2937;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #3b82f6;
}

.period-selector {
    background: #374151;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    margin-left: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">Portfolio Analytics</h1>
            <p class="text-gray-400 mt-2">Comprehensive performance insights and risk analysis</p>
        </div>
        <div class="flex items-center">
            <label class="text-white mr-2">Period:</label>
            <select id="periodSelector" class="period-selector" onchange="updatePeriod()">
                <option value="7" {% if period_days == 7 %}selected{% endif %}>7 Days</option>
                <option value="30" {% if period_days == 30 %}selected{% endif %}>30 Days</option>
                <option value="90" {% if period_days == 90 %}selected{% endif %}>90 Days</option>
                <option value="365" {% if period_days == 365 %}selected{% endif %}>1 Year</option>
            </select>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card">
            <div class="metric-value {% if overview.total_pnl >= 0 %}positive{% else %}negative{% endif %}">
                ${{ "%.2f"|format(overview.total_pnl) }}
            </div>
            <div class="metric-label">Total P&L</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value">{{ overview.total_trades }}</div>
            <div class="metric-label">Total Trades</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value {% if overview.win_rate >= 50 %}positive{% else %}negative{% endif %}">
                {{ overview.win_rate }}%
            </div>
            <div class="metric-label">Win Rate</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value {% if overview.sharpe_ratio >= 1 %}positive{% else %}negative{% endif %}">
                {{ overview.sharpe_ratio }}
            </div>
            <div class="metric-label">Sharpe Ratio</div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">Performance Timeline</h2>
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <!-- Strategy and Provider Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Strategy Performance -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Strategy Performance</h2>
            {% if overview.strategy_performance %}
                {% for strategy, data in overview.strategy_performance.items() %}
                <div class="strategy-card">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-white capitalize">{{ strategy }}</h3>
                        <span class="text-sm {% if data.pnl >= 0 %}positive{% else %}negative{% endif %}">
                            ${{ "%.2f"|format(data.pnl) }}
                        </span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm text-gray-400">
                        <div>Trades: {{ data.trades }}</div>
                        <div>Volume: ${{ "%.0f"|format(data.volume) }}</div>
                        <div>Avg: ${{ "%.2f"|format(data.pnl / data.trades if data.trades > 0 else 0) }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-400">No strategy data available</p>
            {% endif %}
        </div>

        <!-- Provider Performance -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Provider Performance</h2>
            {% if overview.provider_performance %}
                {% for provider, data in overview.provider_performance.items() %}
                <div class="strategy-card">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-white capitalize">{{ provider }}</h3>
                        <span class="text-sm {% if data.pnl >= 0 %}positive{% else %}negative{% endif %}">
                            ${{ "%.2f"|format(data.pnl) }}
                        </span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm text-gray-400">
                        <div>Trades: {{ data.trades }}</div>
                        <div>Volume: ${{ "%.0f"|format(data.volume) }}</div>
                        <div>Avg: ${{ "%.2f"|format(data.pnl / data.trades if data.trades > 0 else 0) }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-400">No provider data available</p>
            {% endif %}
        </div>
    </div>

    <!-- Additional Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-800 rounded-lg p-4">
            <h3 class="text-white font-semibold mb-2">Profit Factor</h3>
            <div class="text-2xl {% if overview.profit_factor >= 1 %}positive{% else %}negative{% endif %}">
                {{ overview.profit_factor }}
            </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4">
            <h3 class="text-white font-semibold mb-2">Max Drawdown</h3>
            <div class="text-2xl negative">
                ${{ "%.2f"|format(overview.max_drawdown) }}
            </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4">
            <h3 class="text-white font-semibold mb-2">Avg Win</h3>
            <div class="text-2xl positive">
                ${{ "%.2f"|format(overview.avg_win) }}
            </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-4">
            <h3 class="text-white font-semibold mb-2">Avg Loss</h3>
            <div class="text-2xl negative">
                ${{ "%.2f"|format(overview.avg_loss) }}
            </div>
        </div>
    </div>

    <!-- Navigation Links -->
    <div class="mt-8 flex space-x-4">
        <a href="{{ url_for('portfolio.performance') }}" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
            Detailed Performance
        </a>
        <a href="{{ url_for('portfolio.risk_analysis') }}" 
           class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors">
            Risk Analysis
        </a>
    </div>
</div>

<script>
// Load performance timeline chart
async function loadPerformanceChart() {
    try {
        const period = document.getElementById('periodSelector').value;
        const response = await fetch(`/portfolio/api/performance-timeline?period=${period}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading timeline data:', data.error);
            return;
        }
        
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.performanceChart) {
            window.performanceChart.destroy();
        }
        
        window.performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.timeline.map(d => d.date),
                datasets: [{
                    label: 'Cumulative P&L',
                    data: data.timeline.map(d => d.cumulative_pnl),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'Daily P&L',
                    data: data.timeline.map(d => d.daily_pnl),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 1,
                    type: 'bar',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: '#374151'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: '#374151'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading performance chart:', error);
    }
}

function updatePeriod() {
    const period = document.getElementById('periodSelector').value;
    window.location.href = `{{ url_for('portfolio.dashboard') }}?period=${period}`;
}

// Load chart on page load
document.addEventListener('DOMContentLoaded', loadPerformanceChart);
</script>
{% endblock %}